<!DOCTYPE HTML>
<html>
  <head>
    <title>Emberbase &ndash; Dashboard</title>
    <link rel="icon" type="image/png" href="/static/img/favicon.png" />
    <script src="/static/js/emberbase.min.js"></script>
    <script src="/static/js/jquery.min.js"></script>
    <link rel="stylesheet" href="/static/css/bootstrap.min.css">
    <style>
      .child {
        padding-left: 40px;
        background-repeat: repeat-y;
        display:none;
        vertical-align: bottom;
      }
      .tree-list {
        list-style-type: none;
        padding-left: 0px;
        margin-left: 0px;
        vertical-align: bottom;
      }
      .tree-text {
        display: inline-block;
        vertical-align: bottom;
      }
      .tree-key {
        color: grey;
      }
      #main {
        padding-left: 30px;
      }
      body {
        padding-top: 70px;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <a class="navbar-brand" href="#"><img src="/static/img/logo.png" alt="logo"/> Emberbase</a>
      </div>
    </nav>
    <div class="container">
      <div class="row">
        <div class="col-lg-12">
          <h3>Dashboard</h3>
          <hr/>
        </div>
      </div>
      <div class="row">
        <div class="col-lg-12">
          <a id="expend-btn" class="btn btn-default" href="#" role="button"><span class="glyphicon glyphicon-plus"></span> Expand all</a>
          <a id="collapse-btn" class="btn btn-default" href="#" role="button"><span class="glyphicon glyphicon-minus"></span> Collapse all</a>
        </div>
      </div>
      <div class="row">
        <div class="col-lg-12">
          <hr/>
        </div>
      </div>
      <div id="main">
        <ul id="tree" class="tree-list">
        </ul>
      </div>
    </div>
    <script>
      var eb = new Emberbase ('http://localhost:8000/<%= route %>');

      $ ('#tree').append ('<li class="parent"><b><%= route %></b></li>');

      eb.on ('child_added', function (snapshot) {
        add_child (snapshot);
        $ ('.parent').find ('.child').css ('background-image', 'url(\'/static/img/wall.png\')');
        $ ('.parent').last ().find ('.child').css ('background-image', 'none');
      });

      eb.on ('value', function (snapshot) {
        $ ('#tree').empty ();
        $ ('#tree').append ('<li class="parent"><b><%= route %></b></li>');
        add_child (snapshot);
      });

      var add_child = function (snapshot) {
        if (typeof snapshot.val !== 'object') {
          var vals = '<li class="child child-'+snapshot.key+'"> \
            <img src="/static/img/corner.png"/> \
            <span class="tree-text">'+snapshot.val+'</span></li>';
        } else {
          var vals = Object.keys (snapshot.val).reduce (function (mem, key, index, list) {
            return mem+'<li class="child child-'+snapshot.key+'"> \
              <img src="/static/img/corner'+((index===list.length-1)?'':'-mid')+'.png"/> \
              <span class="tree-text tree-key">'+key+'</span> : \
              <span class="tree-text">'+snapshot.val[key]+'</span></li>';
          }, '');
        }
        $ ('#tree').append ('<li class="parent"> \
          <img class="parent-img-minus pim-'+snapshot.key+'" style="display:none" src="/static/img/corner-minus.png" /> \
          <img class="parent-img-plus pip-'+snapshot.key+'" src="/static/img/corner-plus.png"/> \
          <span class="tree-text tree-key">'+snapshot.key+'</span> \
          <div><ul class="tree-list">'+vals+'</ul></div></li>');

        $ ('.pim-'+snapshot.key).on ('click', function () {toggle_child (snapshot.key)});
        $ ('.pip-'+snapshot.key).on ('click', function () {toggle_child (snapshot.key)});
      }

      $ ('#expend-btn').on ('click', function () {expend_children ()});
      $ ('#collapse-btn').on ('click', function () {collapse_children ()});
      var toggle_child = function (key) {
        $ ('.child-'+key).toggle ();
        $ ('.pip-'+key).toggle ();
        $ ('.pim-'+key).toggle ();
      };
      var expend_children = function () {
        $ ('.parent-img-minus').show ();
        $ ('.parent-img-plus').hide ();
        $ ('.child').show ();
      };
      var collapse_children = function () {
        $ ('.parent-img-minus').hide ();
        $ ('.parent-img-plus').show ();
        $ ('.child').hide ();
      };
    </script>
  </body>
</html>
